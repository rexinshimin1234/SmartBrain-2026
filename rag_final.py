import os
#ä¸çŸ¥é“ æ“ä½œç³»ç»ŸæŽ¥å£ (Operating System)ã€‚è¿™é‡Œä¸»è¦ç”¨æ¥ä»Žç³»ç»Ÿé‡Œæ‹¿é‚£ä¸ªâ€œä¿é™©ç®±â€é‡Œçš„ API Keyã€‚
import chromadb
#å¼•å…¥å·¥å…·ï¼ŒæŠŠæ–‡æœ¬è½¬åŒ–ä¸ºå‘é‡åæ ‡
from dotenv import load_dotenv
#å¼•å…¥çŽ¯å¢ƒå˜é‡ï¼Œç›®çš„æ˜¯ä¸æŠŠapiå†™åˆ°ä¸»ä»£ç ä¸­
from openai import OpenAI
#å¼•å…¥openaiä¸­çš„OpenAIï¼Œå…·ä½“åšä»€ä¹ˆä¸çŸ¥é“

# 1. å‡†å¤‡å·¥ä½œ
load_dotenv()
#åŠ è½½çŽ¯å¢ƒå˜é‡
client = OpenAI(api_key=os.getenv("DEEPSEEK_API_KEY"), base_url="https://api.deepseek.com")
#åˆ›å»ºç”¨æˆ·ï¼Œå¹¶å¡«å†™apikeyå’Œç½‘å€
# client æ˜¯ä¸€ä¸ªâ€œå¯¹è±¡â€ï¼ˆä½ å¯ä»¥ç†è§£ä¸ºæ‹¥æœ‰å¾ˆå¤šæŠ€èƒ½çš„ AI ç§˜ä¹¦ï¼‰ã€‚
# å®ƒåœ¨åˆå§‹åŒ–æ—¶è®°ä½äº† api_keyï¼Œæ‰€ä»¥åŽé¢æˆ‘ä»¬ç›´æŽ¥æŒ‡æŒ¥å®ƒå¹²æ´»ï¼Œä¸ç”¨å†ä¼ å¯†ç ã€‚
chroma_client = chromadb.PersistentClient(path="./chroma_db")
#åˆ›å»ºchroma_client å¹¶å¼•ç”¨chromadbä¸­çš„PersistentClientï¼Œè¿žæŽ¥åˆ°ç¡¬ç›˜ä¸Šçš„æ•°æ®åº“æ–‡ä»¶ã€‚path="./chroma_db" æ„æ€æ˜¯å‘Šè¯‰å®ƒæ•°æ®å­˜åœ¨å½“å‰ç›®å½•ä¸‹çš„ chroma_db æ–‡ä»¶å¤¹é‡Œã€‚
#Persistent çš„æ„æ€æ˜¯ â€œæŒä¹…åŒ–â€ï¼ˆå­˜ç¡¬ç›˜ï¼Œå…³æœºä¸ä¸¢ï¼‰ã€‚å¦‚æžœä½ ä¸å†™ pathï¼Œå®ƒé»˜è®¤å­˜åœ¨å†…å­˜é‡Œï¼Œç¨‹åºä¸€å…³æ•°æ®å°±æ²¡äº†
# chroma_client ä¹Ÿæ˜¯ä¸€ä¸ªâ€œå¯¹è±¡â€ï¼ˆç®¡ç†ç¡¬ç›˜æ•°æ®çš„ç®¡ç†å‘˜ï¼‰ã€‚
# å®ƒè®°ä½äº† path="./chroma_db"ï¼ŒçŸ¥é“ä»“åº“åœ¨å“ªã€‚

#ä¸çŸ¥é“ï¼Œè¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ªchromadbçš„get_collectionåŠŸèƒ½ï¼Œä½†æ˜¯å…·ä½“ä½œç”¨ä¸å¤ªæ¸…æ¥š
collection = chroma_client.get_collection(name="smartbrain_knowledge")
#å¯åŠ¨é¡µé¢çš„æ‰“å°
print("ðŸ¤– SmartBrain RAG ç³»ç»Ÿå·²å¯åŠ¨ (è¾“å…¥ 'q' é€€å‡º)...")
#å¼€å§‹è¿›å…¥æ­»å¾ªçŽ¯
while True:
    #å®šä¹‰ç”¨æˆ·é—®é¢˜è¿™ä¸ªå˜é‡ï¼Œå…ˆæ¢è¡Œï¼Œå†æ‰“å°User > ï¼Œå¹¶ç”¨strip()åŽ»é™¤ç”¨æˆ·åœ¨é¦–ä½ä¸å°å¿ƒå¤šå¤§çš„ç©ºæ ¼
    user_query = input("\nUser > ").strip()
    #å¦‚æžœç”¨æˆ·æ²¡æœ‰è¾“å…¥ï¼Œç»“æŸè¿™æ¬¡å¾ªçŽ¯ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªçŽ¯ï¼Œç›®çš„æ˜¯é˜²æ­¢ç”¨æˆ·è¾“å…¥å›žè½¦ å¯¼è‡´è¾“å…¥å†…å®¹ä¸ºç©º
    if not user_query: continue
    #å¦‚æžœç”¨æˆ·è¾“å…¥äº†å¤§å†™çš„exitæˆ–è€…qï¼Œæˆ–å°å†™æœ¬èº«ï¼Œç›´æŽ¥é€€å‡ºå¾ªçŽ¯ç»“æŸå¯¹è¯
    if user_query.lower() in ['q', 'exit']: break
    #ç”¨æˆ·è¾“å…¥äº†å†…å®¹ä¹‹åŽï¼Œæ‰“å°æ­£åœ¨æ£€ç´¢
    print("ðŸ” æ­£åœ¨æ£€ç´¢çŸ¥è¯†åº“...")
    
    #è¿™ä¸€è¡Œå®Œå…¨çœ‹ä¸æ‡‚ï¼Œå¥½åƒæ˜¯åœ¨æ ¹æ®ç”¨æˆ·çš„æé—®æ‰¾çŸ¥è¯†åº“ä¸­åŒ¹é…çš„å†…å®¹
    results = collection.query(query_texts=[user_query], n_results=3)
    
    #è¿™é‡Œç”¨äº†æ‹¼æŽ¥å‡½æ•°ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ä¸æ‡‚
    retrieved_text = "\n\n".join(results['documents'][0])
    #å¦‚æžœæ‹¼æŽ¥å†…å®¹ä¸ºç©ºï¼Œæ‰“å°æ²¡æœ‰æ‰¾åˆ°ï¼Œå¹¶è®© context_str = "ï¼ˆæ— å·²çŸ¥ä¿¡æ¯ï¼‰"
    if not retrieved_text:
        print("âš ï¸ çŸ¥è¯†åº“é‡Œæ²¡æ‰¾åˆ°ç›¸å…³å†…å®¹ï¼Œæˆ‘å°†å°è¯•ç›´æŽ¥å›žç­”ã€‚")
        context_str = "ï¼ˆæ— å·²çŸ¥ä¿¡æ¯ï¼‰"
    #å¦‚æžœæ‰¾åˆ°äº†å°±è®©context_str = retrieved_textï¼Œä½†æ˜¯ {len(results['documents'][0])}è¿˜æ˜¯ä¸æ‡‚
    else:
        # æ‰“å°å‡ºæ¥ç»™ä½ è‡ªå·±çœ‹ï¼Œæ–¹ä¾¿è°ƒè¯• (ä¸Šçº¿æ—¶å¯ä»¥å…³æŽ‰)
        print(f"ðŸ“– æ‰¾åˆ°äº† {len(results['documents'][0])} æ¡å‚è€ƒèµ„æ–™ï¼Œæ­£åœ¨æ€è€ƒ...")
        context_str = retrieved_text

    # 4. è¿™é‡Œåº”è¯¥æ˜¯ç»™aiçš„æç¤ºè¯ï¼Œ{context_str}æ˜¯å‚è€ƒèµ„æ–™
    system_prompt = f"""
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å³¡è°·ä¹‹å·…å®¢æœåŠ©æ‰‹ã€‚è¯·ä¸¥æ ¼æ ¹æ®ä¸‹é¢çš„ã€å‚è€ƒèµ„æ–™ã€‘å›žç­”ç”¨æˆ·é—®é¢˜ã€‚
    å¦‚æžœèµ„æ–™é‡Œæåˆ°äº†å…·ä½“æ—¶é—´ï¼ˆå¦‚1æœˆ8æ—¥ï¼‰ï¼Œè¯·åŠ¡å¿…å‡†ç¡®å›žç­”ã€‚
    å¦‚æžœèµ„æ–™é‡Œæ²¡æœ‰ç­”æ¡ˆï¼Œè¯·è¯´â€œçŸ¥è¯†åº“é‡Œæ²¡å†™ï¼Œæˆ‘ä¹Ÿå¸ƒå‰å²›â€ã€‚

    ã€å‚è€ƒèµ„æ–™ã€‘ï¼š
    {context_str}
    """
    #è¿™é‡Œæ˜¯è®©aiå›žç­”å¹¶ï¼Œåº”è¯¥æ ¼å¼æ˜¯å›ºå®šçš„ï¼Œè®°ä½å°±å¥½äº†
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_query}
        ]
    )
    #è¿™é‡Œè¯´çš„æ‰¾aiå›žç­”çš„é€»è¾‘ä¸æ‡‚
    print(f"SmartBrain > {response.choices[0].message.content}")